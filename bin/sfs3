#!/usr/bin/perl

use strict;
use warnings;
use feature qw( say switch );

use YAML qw( LoadFile );
use Net::Async::AmazonS3::FSLike;
use IO::Async::Loop;
use Future;

my $config = LoadFile( "etc/sfs3.conf" );

my $loop = IO::Async::Loop->new;
my $s3 = Net::Async::AmazonS3::FSLike->new(
   access_key => $config->{access_key},
   secret_key => $config->{secret_key},
);
$loop->add( $s3 );

## main
given( shift @ARGV ) {
   when( "ls" ) {
      my $s3path = shift @ARGV;
      my @content = $s3->list_dir(
         bucket => $config->{bucket},
         path   => $s3path,
      )->get;
      say "$_->{type} $_->{name}" for @content;
   }
   when( "cat" ) {
      my $s3path = shift @ARGV;
      $s3->get_file(
         bucket => $config->{bucket},
         path   => $s3path,
         on_chunk => sub {
            my ( $header, $chunk ) = @_;
            print $chunk;
         },
      )->get;
   }
}
